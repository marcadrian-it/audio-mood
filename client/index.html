<!DOCTYPE html>
<html>
  <head>
    <title>Audio Transcription</title>
  </head>
  <body style="background-color: blueviolet">
    <button id="recordButton">Start Recording</button>
    <button id="stopButton" disabled>Stop Recording</button>
    <button id="transcribeButton" disabled>Transcribe Audio</button>
    <audio id="audioPlayer" controls style="display: none"></audio>
    <div id="transcription" style="font-size: x-large"></div>

    <script>
      let mediaRecorder;
      let audioChunks = [];
      let timestamps = []; // Array to store timestamps and sentences

      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.addEventListener('dataavailable', (event) => {
          audioChunks.push(event.data);
        });

        document
          .getElementById('recordButton')
          .addEventListener('click', () => {
            audioChunks = [];
            mediaRecorder.start();
            document.getElementById('stopButton').disabled = false;
          });

        document.getElementById('stopButton').addEventListener('click', () => {
          mediaRecorder.stop();
          document.getElementById('stopButton').disabled = true;
          document.getElementById('transcribeButton').disabled = false;
        });

        document
          .getElementById('transcribeButton')
          .addEventListener('click', () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio', audioBlob);

            fetch('http://localhost:3000/transcribe', {
              method: 'POST',
              body: formData,
            })
              .then((response) => response.json()) // Assume the response is a JSON object containing stdout
              .then((data) => {
                // Parse stdout to get timestamps and sentences
                timestamps = parseStdout(data.stdout);

                // Display sentences in transcription div
                const transcriptionDiv =
                  document.getElementById('transcription');
                transcriptionDiv.innerHTML = '';
                timestamps.forEach((item, index) => {
                  const p = document.createElement('p');
                  p.id = 'sentence-' + index;
                  p.innerText = item.sentence;
                  transcriptionDiv.appendChild(p);
                });

                const url = URL.createObjectURL(audioBlob);
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = url;
                audioPlayer.style.display = 'block';

                // Add ontimeupdate event listener to audio player
                audioPlayer.ontimeupdate = () => {
                  const currentTime = audioPlayer.currentTime;
                  timestamps.forEach((item, index) => {
                    const p = document.getElementById('sentence-' + index);
                    if (
                      currentTime >= item.startTime &&
                      currentTime <= item.endTime
                    ) {
                      p.style.color = 'white';
                    } else {
                      p.style.color = 'black';
                    }
                  });
                };
              })
              .catch((error) => {
                console.error('Error:', error);
              });
          });
      });

      function parseStdout(stdout) {}

      function hmsToSeconds(hms) {
        const parts = hms.split(':');
        return (
          Number(parts[0]) * 60 * 60 + // hours
          Number(parts[1]) * 60 + // minutes
          Number(parts[2]) // seconds
        );
      }
    </script>
  </body>
</html>
